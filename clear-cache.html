<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ScootMe - Clearing Cache</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 40px 20px;
      color: #333;
      line-height: 1.6;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #2c3e50;
      margin-top: 0;
    }
    .progress {
      margin: 30px 0;
      height: 20px;
      background-color: #e9ecef;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background-color: #4caf50;
      border-radius: 10px;
      width: 0%;
      transition: width 1s ease-in-out;
    }
    .message {
      font-size: 16px;
      margin-bottom: 30px;
    }
    .log {
      font-family: monospace;
      text-align: left;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
    }
    .log-item {
      margin-bottom: 5px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .button {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .button:hover {
      background-color: #3367d6;
    }
    .complete {
      color: #4caf50;
      font-weight: bold;
    }
    .error {
      color: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ScootMe Cache Cleaner</h1>
    <div class="message">Clearing cached JavaScript and browser storage...</div>
    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="log" id="log">
      <div class="log-item">‚è≥ Starting cache clearing process...</div>
    </div>

    <button id="continueButton" class="button" style="display: none;">Continue to ScootMe</button>
  </div>

  <script>
    // Update progress bar
    function updateProgress(percent) {
      document.getElementById('progressBar').style.width = `${percent}%`;
    }

    // Add log message
    function addLog(message, type = 'info') {
      const log = document.getElementById('log');
      const logItem = document.createElement('div');
      logItem.className = `log-item ${type}`;
      logItem.textContent = message;
      log.appendChild(logItem);
      log.scrollTop = log.scrollHeight;
    }

    // Complete the process
    function completeProcess() {
      updateProgress(100);
      addLog('‚úÖ Cache clearing complete!', 'complete');
      document.querySelector('.message').textContent = 'Cache has been successfully cleared.';
      
      const continueButton = document.getElementById('continueButton');
      continueButton.style.display = 'inline-block';
      continueButton.addEventListener('click', function() {
        // Add cache busting parameter to URL
        const url = new URL(window.location.origin);
        url.searchParams.set('nocache', Date.now().toString());
        window.location.href = url.toString();
      });
    }

    // Clear cache function
    async function clearCache() {
      try {
        updateProgress(10);
        addLog('üîÑ Clearing localStorage...');
        
        // Clear localStorage
        const localStorageKeys = Object.keys(localStorage);
        addLog(`Found ${localStorageKeys.length} items in localStorage`);
        localStorage.clear();
        
        updateProgress(25);
        addLog('üîÑ Clearing sessionStorage...');
        
        // Clear sessionStorage
        const sessionStorageKeys = Object.keys(sessionStorage);
        addLog(`Found ${sessionStorageKeys.length} items in sessionStorage`);
        sessionStorage.clear();
        
        updateProgress(40);
        addLog('üîÑ Setting cache prevention flags...');
        
        // Set cache-busting flags
        localStorage.setItem('app_version', Date.now().toString());
        localStorage.setItem('cache_cleared_at', Date.now().toString());
        localStorage.setItem('__FIREBASE_DISABLED__', 'true');
        
        updateProgress(60);
        addLog('üîÑ Attempting to clear service worker cache...');
        
        // Clear caches if available
        if ('caches' in window) {
          try {
            const cacheNames = await window.caches.keys();
            addLog(`Found ${cacheNames.length} browser caches`);
            
            for (const cacheName of cacheNames) {
              await window.caches.delete(cacheName);
              addLog(`Deleted cache: ${cacheName}`);
            }
          } catch (e) {
            addLog(`‚ö†Ô∏è Error clearing browser caches: ${e.message}`, 'error');
          }
        } else {
          addLog('‚ö†Ô∏è Browser cache API not available');
        }
        
        updateProgress(85);
        addLog('üîÑ Setting cache-busting script...');
        
        // Create a script that will help prevent Firebase initialization
        const script = document.createElement('script');
        script.textContent = `
          // Block Firebase initialization
          window.__FIREBASE_DISABLED__ = true;
          window.__USING_PASSPORT_OAUTH__ = true;
          
          // Mock Firebase objects
          window.firebase = {
            __DISABLED__: true,
            initializeApp: function() {
              console.error("üõë BLOCKED: Firebase initialization prevented");
              return { __DISABLED__: true };
            }
          };
          
          console.log("üîí Firebase blocking script injected by cache cleaner");
        `;
        document.head.appendChild(script);
        
        updateProgress(95);
        addLog('üîÑ Running final cleanup...');
        
        // Completed
        setTimeout(completeProcess, 500);
      } catch (error) {
        addLog(`‚ùå Error during cache clearing: ${error.message}`, 'error');
        updateProgress(100);
        
        // Still show continue button even if there was an error
        document.getElementById('continueButton').style.display = 'inline-block';
      }
    }

    // Start the process
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(clearCache, 500);
    });
  </script>
</body>
</html>